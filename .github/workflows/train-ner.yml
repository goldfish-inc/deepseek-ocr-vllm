name: Train and Publish NER Model
# ESC-powered workflow

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 3 * * *'  # daily at 03:00 UTC

permissions:
  contents: read

jobs:
  train-export-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Export HF token from ESC
        id: esc
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          # Install ESC CLI
          curl -fsSL https://get.pulumi.com/esc/install.sh | sh
          export PATH="$HOME/.pulumi/bin:$PATH"

          # Get HF token from ESC (camelCase key to match Pulumi config)
          HF_TOKEN=$(esc env get default/oceanid-cluster pulumiConfig.oceanid-cluster:hfAccessToken --show-secrets --value string)
          if [ -z "$HF_TOKEN" ] || [ "$HF_TOKEN" = "[secret]" ]; then
            echo "âŒ HF token not found in ESC (pulumiConfig.oceanid-cluster:hfAccessToken)" >&2
            exit 1
          fi
          echo "::add-mask::$HF_TOKEN"
          echo "HF_TOKEN=$HF_TOKEN" >> $GITHUB_ENV

          # Get HF repos from ESC (with sensible defaults)
          HF_DATASET_REPO=$(esc env get default/oceanid-cluster pulumiConfig.oceanid-cluster:hfDatasetRepo --value string 2>/dev/null || echo "goldfish-inc/oceanid-annotations")
          HF_MODEL_REPO=$(esc env get default/oceanid-cluster pulumiConfig.oceanid-cluster:hfModelRepo --value string 2>/dev/null || echo "goldfish-inc/oceanid-ner-distilbert")
          if [ -z "$HF_DATASET_REPO" ]; then HF_DATASET_REPO="goldfish-inc/oceanid-annotations"; fi
          if [ -z "$HF_MODEL_REPO" ]; then HF_MODEL_REPO="goldfish-inc/oceanid-ner-distilbert"; fi
          echo "HF_DATASET_REPO=$HF_DATASET_REPO" >> $GITHUB_ENV
          echo "HF_MODEL_REPO=$HF_MODEL_REPO" >> $GITHUB_ENV

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install transformers datasets "optimum[exporters]" onnxruntime huggingface_hub

      - name: Fetch HF dataset annotations
        env:
          HF_TOKEN: ${{ env.HF_TOKEN }}
          HF_DATASET_REPO: ${{ env.HF_DATASET_REPO }}
        run: |
          python - << 'PY'
          import os, json, pathlib
          from huggingface_hub import HfApi, hf_hub_download, list_repo_files
          HF_TOKEN=os.environ['HF_TOKEN']
          REPO=os.environ.get('HF_DATASET_REPO','goldfish-inc/oceanid-annotations')
          api=HfApi(token=HF_TOKEN)
          out=pathlib.Path('local_annotations'); out.mkdir(exist_ok=True)
          for f in list_repo_files(REPO, repo_type='dataset'):
              if f.startswith('annotations/') and f.endswith('.jsonl'):
                  p=hf_hub_download(REPO, filename=f, repo_type='dataset', token=HF_TOKEN)
                  dst=out/ pathlib.Path(f).name
                  open(dst,'wb').write(open(p,'rb').read())
          print('downloaded jsonl files to', out)
          PY

      - name: Train NER
        run: |
          python scripts/ner_train.py --labels labels.json --data-dir ./local_annotations --out ./models/ner-distilbert

      - name: Export ONNX
        run: |
          bash scripts/export_onnx.sh ./models/ner-distilbert distilbert_onnx 63

      - name: Publish ONNX to HF model repo
        env:
          HF_TOKEN: ${{ env.HF_TOKEN }}
          HF_MODEL_REPO: ${{ env.HF_MODEL_REPO }}
        run: |
          python - << 'PY'
          import os, io
          from datetime import datetime
          from huggingface_hub import HfApi, CommitOperationAdd
          repo=os.environ.get('HF_MODEL_REPO','goldfish-inc/oceanid-ner-distilbert')
          api=HfApi(token=os.environ['HF_TOKEN'])
          api.create_repo(repo_id=repo, repo_type='model', private=True, exist_ok=True)
          bin=open('distilbert_onnx/model.onnx','rb').read()
          op=CommitOperationAdd(path_in_repo='onnx/model.onnx', path_or_fileobj=io.BytesIO(bin))
          api.create_commit(repo_id=repo, repo_type='model', operations=[op], commit_message=f"Update ONNX {datetime.utcnow().isoformat()}Z")
          print('published ONNX to', repo)
          PY
