name: Train and Publish NER Model

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 3 * * *'  # daily at 03:00 UTC

permissions:
  contents: read

jobs:
  train-export-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install transformers datasets "optimum[exporters]" onnxruntime huggingface_hub

      - name: Prepare labels.json from secret
        env:
          NER_LABELS_JSON: ${{ secrets.NER_LABELS_JSON }}
        run: |
          if [ -z "${NER_LABELS_JSON}" ]; then echo "NER_LABELS_JSON secret is required"; exit 1; fi
          echo "${NER_LABELS_JSON}" > labels.json

      - name: Fetch HF dataset annotations
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_DATASET_REPO: ${{ vars.HF_DATASET_REPO || 'goldfish-inc/oceanid-annotations' }}
        run: |
          python - <<'PY'
import os, json, pathlib
from huggingface_hub import HfApi, hf_hub_download, list_repo_files
HF_TOKEN=os.environ['HF_TOKEN']
REPO=os.environ.get('HF_DATASET_REPO','goldfish-inc/oceanid-annotations')
api=HfApi(token=HF_TOKEN)
out=pathlib.Path('local_annotations'); out.mkdir(exist_ok=True)
for f in list_repo_files(REPO, repo_type='dataset'):
    if f.startswith('annotations/') and f.endswith('.jsonl'):
        p=hf_hub_download(REPO, filename=f, repo_type='dataset', token=HF_TOKEN)
        dst=out/ pathlib.Path(f).name
        open(dst,'wb').write(open(p,'rb').read())
print('downloaded jsonl files to', out)
PY

      - name: Train NER
        run: |
          python scripts/ner_train.py --labels labels.json --data-dir ./local_annotations --out ./models/ner-distilbert

      - name: Export ONNX
        run: |
          bash scripts/export_onnx.sh ./models/ner-distilbert distilbert_onnx 63

      - name: Publish ONNX to HF model repo
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_MODEL_REPO: ${{ vars.HF_MODEL_REPO || 'goldfish-inc/oceanid-ner-distilbert' }}
        run: |
          python - <<'PY'
import os, io
from datetime import datetime
from huggingface_hub import HfApi, CommitOperationAdd
repo=os.environ.get('HF_MODEL_REPO','goldfish-inc/oceanid-ner-distilbert')
api=HfApi(token=os.environ['HF_TOKEN'])
api.create_repo(repo_id=repo, repo_type='model', private=True, exist_ok=True)
bin=open('distilbert_onnx/model.onnx','rb').read()
op=CommitOperationAdd(path_in_repo='onnx/model.onnx', path_or_fileobj=io.BytesIO(bin))
api.create_commit(repo_id=repo, repo_type='model', operations=[op], commit_message=f"Update ONNX {datetime.utcnow().isoformat()}Z")
print('published ONNX to', repo)
PY
