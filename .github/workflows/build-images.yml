name: Build and Push Images

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/ls-triton-adapter/**'
      - 'apps/annotations-sink/**'
      - 'apps/project-bootstrapper/**'
      - 'apps/training-worker/**'
      - 'apps/csv-ingestion-worker/**'
      - 'apps/document-extraction-service/**'

permissions:
  contents: read
  packages: write

jobs:
  build-go-adapter:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Go adapter image
        uses: docker/build-push-action@v6
        with:
          context: ./apps/ls-triton-adapter
          push: true
          tags: |
            ghcr.io/goldfish-inc/oceanid/ls-triton-adapter:${{ github.sha }}
            ghcr.io/goldfish-inc/oceanid/ls-triton-adapter:main
          cache-from: type=registry,ref=ghcr.io/goldfish-inc/oceanid/ls-triton-adapter:buildcache
          cache-to: type=registry,ref=ghcr.io/goldfish-inc/oceanid/ls-triton-adapter:buildcache,mode=max

  build-go-sink:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Go sink image
        uses: docker/build-push-action@v6
        with:
          context: ./apps/annotations-sink
          push: true
          tags: |
            ghcr.io/goldfish-inc/oceanid/annotations-sink:${{ github.sha }}
            ghcr.io/goldfish-inc/oceanid/annotations-sink:main
          cache-from: type=registry,ref=ghcr.io/goldfish-inc/oceanid/annotations-sink:buildcache
          cache-to: type=registry,ref=ghcr.io/goldfish-inc/oceanid/annotations-sink:buildcache,mode=max

  build-bootstrapper:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push bootstrapper image
        uses: docker/build-push-action@v6
        with:
          context: ./apps/project-bootstrapper
          push: true
          tags: |
            ghcr.io/goldfish-inc/oceanid/project-bootstrapper:${{ github.sha }}
            ghcr.io/goldfish-inc/oceanid/project-bootstrapper:main
          cache-from: type=registry,ref=ghcr.io/goldfish-inc/oceanid/project-bootstrapper:buildcache
          cache-to: type=registry,ref=ghcr.io/goldfish-inc/oceanid/project-bootstrapper:buildcache,mode=max

  build-training-worker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push training-worker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/training-worker/Dockerfile
          push: true
          tags: |
            ghcr.io/goldfish-inc/oceanid/training-worker:${{ github.sha }}
            ghcr.io/goldfish-inc/oceanid/training-worker:main
          cache-from: type=registry,ref=ghcr.io/goldfish-inc/oceanid/training-worker:buildcache
          cache-to: type=registry,ref=ghcr.io/goldfish-inc/oceanid/training-worker:buildcache,mode=max

  build-csv-worker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push csv-ingestion-worker image
        uses: docker/build-push-action@v6
        with:
          context: ./apps/csv-ingestion-worker
          push: true
          tags: |
            ghcr.io/goldfish-inc/oceanid/csv-ingestion-worker:${{ github.sha }}
            ghcr.io/goldfish-inc/oceanid/csv-ingestion-worker:main
          cache-from: type=registry,ref=ghcr.io/goldfish-inc/oceanid/csv-ingestion-worker:buildcache
          cache-to: type=registry,ref=ghcr.io/goldfish-inc/oceanid/csv-ingestion-worker:buildcache,mode=max

      - name: Smoke test CSV worker image
        run: |
          set -euo pipefail

          IMAGE="ghcr.io/goldfish-inc/oceanid/csv-ingestion-worker:${{ github.sha }}"
          echo "ðŸ§ª Running smoke test for: $IMAGE"

          # Run container with dummy environment (SKIP_DB_CHECK=true for smoke tests)
          docker run --rm -d \
            --name csv-worker-test \
            -e DATABASE_URL="postgresql://test:test@localhost:5432/test" \
            -e S3_BUCKET="test-bucket" \
            -e LABEL_STUDIO_URL="http://test" \
            -e SKIP_DB_CHECK="true" \
            "$IMAGE" || {
            echo "âŒ Container failed to start"
            exit 1
          }

          # Wait for startup (max 15 seconds)
          echo "â³ Waiting for container to initialize..."
          for i in {1..15}; do
            if ! docker ps | grep -q csv-worker-test; then
              echo "âŒ Container crashed during startup!"
              docker logs csv-worker-test 2>&1 || true
              exit 1
            fi
            sleep 1
          done

          # Check health endpoint
          docker exec csv-worker-test wget --spider -q http://localhost:8080/live || {
            echo "âš ï¸  Health endpoint not responding (expected without real DB)"
          }

          # Cleanup
          docker stop csv-worker-test || true

          echo "âœ… Smoke test passed"

  build-document-extraction:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push document-extraction image
        uses: docker/build-push-action@v6
        with:
          context: ./apps/document-extraction-service
          push: true
          tags: |
            ghcr.io/goldfish-inc/oceanid/document-extraction:${{ github.sha }}
            ghcr.io/goldfish-inc/oceanid/document-extraction:main
          cache-from: type=registry,ref=ghcr.io/goldfish-inc/oceanid/document-extraction:buildcache
          cache-to: type=registry,ref=ghcr.io/goldfish-inc/oceanid/document-extraction:buildcache,mode=max

      - name: Smoke test document-extraction image
        run: |
          set -euo pipefail

          IMAGE="ghcr.io/goldfish-inc/oceanid/document-extraction:${{ github.sha }}"
          echo "ðŸ§ª Running smoke test for: $IMAGE"

          # Run container
          docker run --rm -d \
            --name doc-extract-test \
            -p 8080:8080 \
            "$IMAGE" || {
            echo "âŒ Container failed to start"
            exit 1
          }

          # Wait for startup (max 30 seconds, docling models load)
          echo "â³ Waiting for container to initialize..."
          for i in {1..30}; do
            if ! docker ps | grep -q doc-extract-test; then
              echo "âŒ Container crashed during startup!"
              docker logs doc-extract-test 2>&1 || true
              exit 1
            fi
            sleep 1
          done

          # Check health endpoint
          if docker exec doc-extract-test wget --spider -q http://localhost:8080/health; then
            echo "âœ… Health endpoint responding"
          else
            echo "âŒ Health endpoint not responding"
            docker logs doc-extract-test 2>&1
            docker stop doc-extract-test || true
            exit 1
          fi

          # Cleanup
          docker stop doc-extract-test || true

          echo "âœ… Smoke test passed"
