name: Update Image Tags

on:
  workflow_run:
    workflows: ["Build and Push Images"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      sink_image:
        description: 'Sink image tag (leave empty to use latest SHA)'
        required: false
      csv_image:
        description: 'CSV worker image tag (leave empty to use latest SHA)'
        required: false
      training_worker_image:
        description: 'Training worker image tag (leave empty to use latest SHA)'
        required: false

permissions:
  contents: read
  packages: read

jobs:
  update-config:
    runs-on: ubuntu-latest
    # Only run if build workflow succeeded or manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - uses: actions/checkout@v4
        with:
          # Get the commit that triggered the build workflow
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Install ESC CLI
        run: |
          curl -fsSL https://get.pulumi.com/esc/install.sh | sh
          echo "$HOME/.pulumi/bin" >> $GITHUB_PATH

      - name: Determine image tags
        id: images
        run: |
          # Use manual input if provided, otherwise use commit SHA
          COMMIT_SHA="${{ github.event.workflow_run.head_sha || github.sha }}"

          SINK_IMAGE="${{ inputs.sink_image }}"
          if [ -z "$SINK_IMAGE" ]; then
            SINK_IMAGE="ghcr.io/goldfish-inc/oceanid/annotations-sink:${COMMIT_SHA}"
          fi

          CSV_IMAGE="${{ inputs.csv_image }}"
          if [ -z "$CSV_IMAGE" ]; then
            CSV_IMAGE="ghcr.io/goldfish-inc/oceanid/csv-ingestion-worker:${COMMIT_SHA}"
          fi

          TRAINING_WORKER_IMAGE="${{ inputs.training_worker_image }}"
          if [ -z "$TRAINING_WORKER_IMAGE" ]; then
            TRAINING_WORKER_IMAGE="ghcr.io/goldfish-inc/oceanid/training-worker:${COMMIT_SHA}"
          fi

          echo "sink_image=${SINK_IMAGE}" >> $GITHUB_OUTPUT
          echo "csv_image=${CSV_IMAGE}" >> $GITHUB_OUTPUT
          echo "training_worker_image=${TRAINING_WORKER_IMAGE}" >> $GITHUB_OUTPUT

          echo "Will deploy:"
          echo "  Sink: ${SINK_IMAGE}"
          echo "  CSV Worker: ${CSV_IMAGE}"
          echo "  Training Worker: ${TRAINING_WORKER_IMAGE}"

      - name: Update ESC config with new image tags
        run: |
          esc env set default/oceanid-cluster \
            "pulumiConfig.oceanid-cluster:sinkImage" \
            "${{ steps.images.outputs.sink_image }}" \
            --plaintext

          esc env set default/oceanid-cluster \
            "pulumiConfig.oceanid-cluster:csvWorkerImage" \
            "${{ steps.images.outputs.csv_image }}" \
            --plaintext

          esc env set default/oceanid-cluster \
            "pulumiConfig.oceanid-cluster:trainingWorkerImage" \
            "${{ steps.images.outputs.training_worker_image }}" \
            --plaintext
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Summary
        run: |
          echo "âœ… ESC config updated with immutable image tags"
          echo ""
          echo "Image tags updated to:"
          echo "  Sink: ${{ steps.images.outputs.sink_image }}"
          echo "  CSV Worker: ${{ steps.images.outputs.csv_image }}"
          echo "  Training Worker: ${{ steps.images.outputs.training_worker_image }}"
          echo ""
          echo "Cluster applies are handled by a GitHub self-hosted runner on a host with kubeconfig access (e.g., tethys)."
          echo "Ensure the runner is online; pushes to main that touch cluster/ will trigger an apply via cluster-selfhosted.yml."
