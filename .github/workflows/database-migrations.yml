name: database-migrations

on:
  workflow_dispatch:
    inputs:
      migration_version:
        description: 'Migration version to apply (V3, V4, V5, V6, or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - V3
          - V4
          - V5
          - V6
      dry_run:
        description: 'Dry run (preview only, do not apply)'
        required: false
        default: true
        type: boolean

  # Trigger on push to sql/migrations/ directory
  push:
    branches:
      - main
    paths:
      - 'sql/migrations/**'
      - '.github/workflows/database-migrations.yml'

permissions:
  contents: read
  id-token: write

jobs:
  migrate:
    runs-on: ubuntu-24.04
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@eef61447b9ff4aafe5dcd4e0bbf5d482be7e7871 # v4.2.1
        with:
          fetch-depth: 1

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client-16
          psql --version

      - name: Configure Pulumi ESC access
        uses: pulumi/auth-actions@v1
        with:
          organization: ryan-taylor
          requested-token-type: urn:pulumi:token-type:access_token:organization

      - name: Export database URL from ESC
        id: esc
        run: |
          # Install ESC CLI
          curl -fsSL https://get.pulumi.com/esc/install.sh | sh
          export PATH="$HOME/.pulumi/bin:$PATH"

          # Get database URL from ESC (encrypted)
          DATABASE_URL=$(esc env get default/oceanid-cluster --value pulumiConfig.oceanid-cluster:postgres_url)

          # Mask secret in logs
          echo "::add-mask::$DATABASE_URL"
          echo "DATABASE_URL=$DATABASE_URL" >> $GITHUB_OUTPUT

          if [ -z "$DATABASE_URL" ]; then
            echo "‚ÑπÔ∏è No DATABASE_URL found in ESC. Skipping migrations gracefully."
            echo "SKIP=true" >> $GITHUB_OUTPUT
          fi

      - name: Verify database connection
        if: ${{ steps.esc.outputs.SKIP != 'true' }}
        env:
          DATABASE_URL: ${{ steps.esc.outputs.DATABASE_URL }}
        run: |
          echo "üîç Testing database connection..."
          psql "$DATABASE_URL" -c "SELECT version();" || {
            echo "‚ùå Database connection failed"
            exit 1
          }
          echo "‚úÖ Database connection successful"

      - name: Ensure required extensions (pgcrypto, postgis, btree_gist)
        if: ${{ steps.esc.outputs.SKIP != 'true' && github.event.inputs.dry_run == 'false' }}
        env:
          DATABASE_URL: ${{ steps.esc.outputs.DATABASE_URL }}
        run: |
          echo "üîß Ensuring required extensions are installed..."
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c "CREATE EXTENSION IF NOT EXISTS pgcrypto; CREATE EXTENSION IF NOT EXISTS postgis; CREATE EXTENSION IF NOT EXISTS btree_gist;"
          echo "‚úÖ Extensions ensured"

      - name: Check existing migrations
        if: ${{ steps.esc.outputs.SKIP != 'true' }}
        id: check
        env:
          DATABASE_URL: ${{ steps.esc.outputs.DATABASE_URL }}
        run: |
          echo "üìã Checking applied migrations..."

          # Check if control.schema_versions exists
          SCHEMA_EXISTS=$(psql "$DATABASE_URL" -tAc "
            SELECT EXISTS (
              SELECT 1 FROM information_schema.tables
              WHERE table_schema = 'control'
              AND table_name = 'schema_versions'
            );
          ")

          if [ "$SCHEMA_EXISTS" = "t" ]; then
            echo "‚úÖ control.schema_versions exists"
            psql "$DATABASE_URL" -c "SELECT domain, version, activated_at FROM control.schema_versions ORDER BY activated_at;"
          else
            echo "‚ö†Ô∏è  control.schema_versions does not exist (first migration)"
          fi

      - name: Apply V3 migration (staging tables)
        if: ${{ steps.esc.outputs.SKIP != 'true' && (github.event.inputs.migration_version == 'all' || github.event.inputs.migration_version == 'V3') && github.event.inputs.dry_run == 'false' }}
        env:
          DATABASE_URL: ${{ steps.esc.outputs.DATABASE_URL }}
        run: |
          echo "============================================"
          echo "Applying V3: Staging Tables"
          echo "============================================"

          # Check if already applied
          APPLIED=$(psql "$DATABASE_URL" -tAc "
            SELECT EXISTS (
              SELECT 1 FROM control.schema_versions
              WHERE domain = 'V3'
            );
          " || echo "f")

          if [ "$APPLIED" = "t" ]; then
            echo "‚è≠Ô∏è  V3 already applied, skipping..."
            exit 0
          fi

          # Apply migration
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f sql/migrations/V3__staging_tables_complete.sql

          # Record in control.schema_versions
          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c "INSERT INTO control.schema_versions (domain, version, activated_at) VALUES ('V3', 'V3__staging_tables_complete.sql', now()) ON CONFLICT (domain) DO UPDATE SET version = EXCLUDED.version, activated_at = EXCLUDED.activated_at;"

          echo "‚úÖ V3 migration completed"

      - name: Apply V4 migration (reference tables)
        if: ${{ steps.esc.outputs.SKIP != 'true' && (github.event.inputs.migration_version == 'all' || github.event.inputs.migration_version == 'V4') && github.event.inputs.dry_run == 'false' }}
        env:
          DATABASE_URL: ${{ steps.esc.outputs.DATABASE_URL }}
        run: |
          echo "============================================"
          echo "Applying V4: Reference Tables"
          echo "============================================"

          APPLIED=$(psql "$DATABASE_URL" -tAc "
            SELECT EXISTS (
              SELECT 1 FROM control.schema_versions
              WHERE domain = 'V4'
            );
          " || echo "f")

          if [ "$APPLIED" = "t" ]; then
            echo "‚è≠Ô∏è  V4 already applied, skipping..."
            exit 0
          fi

          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f sql/migrations/V4__curated_reference_tables.sql

          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c "INSERT INTO control.schema_versions (domain, version, activated_at) VALUES ('V4', 'V4__curated_reference_tables.sql', now()) ON CONFLICT (domain) DO UPDATE SET version = EXCLUDED.version, activated_at = EXCLUDED.activated_at;"

          echo "‚úÖ V4 migration completed"

      - name: Apply V5 migration (temporal events)
        if: ${{ steps.esc.outputs.SKIP != 'true' && (github.event.inputs.migration_version == 'all' || github.event.inputs.migration_version == 'V5') && github.event.inputs.dry_run == 'false' }}
        env:
          DATABASE_URL: ${{ steps.esc.outputs.DATABASE_URL }}
        run: |
          echo "============================================"
          echo "Applying V5: Temporal Events"
          echo "============================================"

          APPLIED=$(psql "$DATABASE_URL" -tAc "
            SELECT EXISTS (
              SELECT 1 FROM control.schema_versions
              WHERE domain = 'V5'
            );
          " || echo "f")

          if [ "$APPLIED" = "t" ]; then
            echo "‚è≠Ô∏è  V5 already applied, skipping..."
            exit 0
          fi

          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f sql/migrations/V5__curated_temporal_events.sql

          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c "INSERT INTO control.schema_versions (domain, version, activated_at) VALUES ('V5', 'V5__curated_temporal_events.sql', now()) ON CONFLICT (domain) DO UPDATE SET version = EXCLUDED.version, activated_at = EXCLUDED.activated_at;"

          echo "‚úÖ V5 migration completed"

      - name: Apply V6 migration (vessel_info typed)
        if: ${{ steps.esc.outputs.SKIP != 'true' && (github.event.inputs.migration_version == 'all' || github.event.inputs.migration_version == 'V6') && github.event.inputs.dry_run == 'false' }}
        env:
          DATABASE_URL: ${{ steps.esc.outputs.DATABASE_URL }}
        run: |
          echo "============================================"
          echo "Applying V6: Vessel Info Typed Columns"
          echo "============================================"

          APPLIED=$(psql "$DATABASE_URL" -tAc "
            SELECT EXISTS (
              SELECT 1 FROM control.schema_versions
              WHERE domain = 'V6'
            );
          " || echo "f")

          if [ "$APPLIED" = "t" ]; then
            echo "‚è≠Ô∏è  V6 already applied, skipping..."
            exit 0
          fi

          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -f sql/migrations/V6__vessel_info_typed_columns.sql

          psql "$DATABASE_URL" -v ON_ERROR_STOP=1 -c "INSERT INTO control.schema_versions (domain, version, activated_at) VALUES ('V6', 'V6__vessel_info_typed_columns.sql', now()) ON CONFLICT (domain) DO UPDATE SET version = EXCLUDED.version, activated_at = EXCLUDED.activated_at;"

          echo "‚úÖ V6 migration completed"

      - name: Dry run summary
        if: ${{ steps.esc.outputs.SKIP != 'true' && github.event.inputs.dry_run == 'true' }}
        env:
          DATABASE_URL: ${{ steps.esc.outputs.DATABASE_URL }}
        run: |
          echo "============================================"
          echo "üîç DRY RUN - No migrations applied"
          echo "============================================"
          echo ""
          echo "Would apply: ${{ github.event.inputs.migration_version }}"
          echo ""
          echo "To apply migrations, re-run with dry_run=false"

      - name: Verify final state
        if: ${{ steps.esc.outputs.SKIP != 'true' && github.event.inputs.dry_run == 'false' }}
        env:
          DATABASE_URL: ${{ steps.esc.outputs.DATABASE_URL }}
        run: |
          echo "============================================"
          echo "‚úÖ Migration Summary"
          echo "============================================"

          psql "$DATABASE_URL" -c "
            SELECT
              domain as \"Migration\",
              version as \"File\",
              activated_at as \"Applied At\"
            FROM control.schema_versions
            ORDER BY activated_at;
          "

          echo ""
          echo "‚úÖ All requested migrations applied successfully"
      - name: Skipped (no DATABASE_URL configured)
        if: ${{ steps.esc.outputs.SKIP == 'true' }}
        run: |
          echo "‚ÑπÔ∏è database-migrations: No DATABASE_URL configured in ESC. Skipping migrations with success."
