name: Seed Living Schema Plan

on:
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write

jobs:
  seed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Seed Living Schema issues from manifest
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const manifestPath = path.join(process.cwd(), '.github/issue-manifest-living-schema.json');
            const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));

            async function getAllLabels() {
              const res = await github.rest.issues.listLabelsForRepo({ owner, repo, per_page: 100 });
              return new Set(res.data.map(l => l.name));
            }

            async function ensureLabel(name, color = '6f42c1', description = '') {
              try {
                await github.rest.issues.createLabel({ owner, repo, name, color, description });
                core.info(`Created label: ${name}`);
              } catch (e) {
                if (e.status === 422) {
                  core.info(`Label exists: ${name}`);
                } else {
                  core.warning(`Label error (${name}): ${e.message}`);
                }
              }
            }

            async function findIssueByTitle(title) {
              const open = await github.rest.issues.listForRepo({owner, repo, state: 'open', per_page: 100});
              const closed = await github.rest.issues.listForRepo({owner, repo, state: 'closed', per_page: 100});
              return [...open.data, ...closed.data].find(i => i.title === title);
            }

            async function ensureIssue(title, body, labels) {
              const existing = await findIssueByTitle(title);
              if (existing) { core.info(`Exists: #${existing.number} ${title}`); return existing; }
              const res = await github.rest.issues.create({owner, repo, title, body, labels});
              core.info(`Created: #${res.data.number} ${title}`);
              return res.data;
            }

            // 1) Ensure labels
            const neededLabels = new Set();
            const collect = (arr) => (arr || []).forEach(l => neededLabels.add(l));
            if (manifest.program?.labels) collect(manifest.program.labels);
            for (const epic of manifest.epics || []) {
              collect(epic.labels || []);
              for (const it of epic.issues || []) collect(it.labels || []);
            }
            const existing = await getAllLabels();
            for (const label of neededLabels) {
              if (!existing.has(label)) {
                const color = label.startsWith('phase:') ? '0366d6'
                             : label.startsWith('area:') ? '0e8a16'
                             : label.startsWith('priority:') ? 'd93f0b'
                             : label.startsWith('initiative:') ? '6f42c1'
                             : label === 'epic' ? 'b60205'
                             : '6a737d';
                await ensureLabel(label, color);
              }
            }

            // 2) Create Program issue
            let programIssue = null;
            if (manifest.program) {
              programIssue = await ensureIssue(
                manifest.program.title,
                manifest.program.body,
                manifest.program.labels || []
              );
            }

            // 3) Create Epics and Issues
            const epicIssues = [];
            for (const epic of manifest.epics || []) {
              const epicIssue = await ensureIssue(epic.title, epic.body, epic.labels || []);
              epicIssues.push(epicIssue);
              for (const it of epic.issues || []) {
                const body = `Epic: #${epicIssue.number}\n\n${it.body || ''}`;
                await ensureIssue(it.title, body, (it.labels || []));
              }
            }

            // 4) Update Program issue with checklist of Epics
            if (programIssue && epicIssues.length) {
              const checklist = epicIssues.map(e => `- [ ] #${e.number} ${e.title}`).join('\n');
              const newBody = `${manifest.program.body}\n\n### Phase Epics\n${checklist}`;
              await github.rest.issues.update({owner, repo, issue_number: programIssue.number, body: newBody});
            }

            core.notice('Living Schema seeding complete.');
