# Pre-push hook to run Go tests and Docker image builds
# This prevents pushing broken code that would cause deploy failures

echo "üß™ Running pre-push checks..."

# Detect changed apps with Dockerfiles
CHANGED_APPS=$(git diff --name-only @{upstream}...HEAD 2>/dev/null | grep '^apps/' | cut -d'/' -f1-2 | sort -u || true)

# Check if CSV worker code changed (for Go tests)
CSV_WORKER_CHANGED=$(echo "$CHANGED_APPS" | grep 'apps/csv-ingestion-worker' || true)

if [ -n "$CSV_WORKER_CHANGED" ]; then
    echo "üì¶ CSV ingestion worker code changed, running tests..."

    cd apps/csv-ingestion-worker

    # Check if Go is installed
    if ! command -v go >/dev/null 2>&1; then
        echo "‚ö†Ô∏è  Go not installed, skipping tests"
        cd ../..
    else
        # Run go test
        echo "  ‚Üí Running go test..."
        if ! go test ./...; then
            echo "‚ùå CSV worker tests failed!"
            echo "Fix the tests before pushing, or use --no-verify to skip this check."
            cd ../..
            exit 1
        fi

        # Check if code compiles
        echo "  ‚Üí Checking if code compiles..."
        if ! go build -o /dev/null .; then
            echo "‚ùå CSV worker build failed!"
            echo "Fix the build errors before pushing, or use --no-verify to skip this check."
            cd ../..
            exit 1
        fi

        cd ../..
        echo "‚úÖ CSV worker tests passed"
    fi
else
    echo "  CSV worker unchanged, skipping tests"
fi

# Validate Dockerfiles for changed apps (fast check without building)
if [ -n "$CHANGED_APPS" ]; then
    echo "üê≥ Validating Dockerfiles for changed apps..."

    # Check if Docker is installed
    if ! command -v docker >/dev/null 2>&1; then
        echo "‚ö†Ô∏è  Docker not installed, skipping Dockerfile validation"
    else
        CHECK_FAILED=0

        for app_path in $CHANGED_APPS; do
            if [ -f "$app_path/Dockerfile" ]; then
                app_name=$(basename "$app_path")
                echo "  ‚Üí Checking $app_name Dockerfile..."

                # Validate with buildx --check (fast, no actual build)
                # Exit code 0 = success (warnings are OK), non-zero = errors
                if docker buildx build --check -f "$app_path/Dockerfile" "$app_path" >/dev/null 2>&1; then
                    echo "    ‚úÖ $app_name Dockerfile valid"
                else
                    echo "‚ùå Dockerfile validation failed for $app_name!"
                    docker buildx build --check -f "$app_path/Dockerfile" "$app_path"
                    CHECK_FAILED=1
                fi
            fi
        done

        if [ $CHECK_FAILED -eq 1 ]; then
            echo "‚ùå Dockerfile validation(s) failed!"
            echo "Fix the Dockerfiles before pushing, or use --no-verify to skip this check."
            exit 1
        fi

        echo "‚úÖ All Dockerfiles validated successfully"
    fi
else
    echo "  No app changes detected, skipping Dockerfile validation"
fi

echo "‚úÖ Pre-push checks complete"
