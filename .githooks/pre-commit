#!/usr/bin/env bash
set -euo pipefail

echo "[pre-commit] Validating workspace..."

if ! command -v pnpm >/dev/null 2>&1; then
  echo "pnpm is required. Install pnpm 9.x and retry." >&2
  exit 1
fi

# Type check (no emit) for TS projects
echo "[pre-commit] Type-checking cluster..."
pnpm --filter @oceanid/cluster lint

echo "[pre-commit] Type-checking policy helpers..."
pnpm --filter @oceanid/policy lint

# Optional: format Rego files
if pnpm --silent --filter @oceanid/policy fmt >/dev/null 2>&1; then
  git add policy/opa-policies.rego || true
fi

# OPA policy tests (require opa CLI unless skipped)
if [[ "${SKIP_OPA:-0}" == "1" ]]; then
  echo "[pre-commit] Skipping OPA tests (SKIP_OPA=1)"
else
  if command -v opa >/dev/null 2>&1; then
    echo "[pre-commit] Running OPA tests..."
    pnpm --filter @oceanid/policy test
  else
    echo "OPA CLI not found. Install OPA or set SKIP_OPA=1 to bypass." >&2
    exit 1
  fi
fi

echo "[pre-commit] All checks passed."
