apiVersion: batch/v1
kind: Job
metadata:
  name: bootstrapper-smoke-test
  namespace: apps
spec:
  ttlSecondsAfterFinished: 300  # Auto-cleanup after 5 minutes
  backoffLimit: 2
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: smoke-test
          image: curlimages/curl:8.10.1
          command:
            - sh
            - -c
            - |
              set -e
              echo "üîç Testing project-bootstrapper endpoints..."
              BASE_URL="http://project-bootstrapper.apps.svc.cluster.local:8080"

              # Test /health endpoint
              echo ""
              echo "1Ô∏è‚É£  Testing /health..."
              STATUS=$(curl -s -o /dev/null -w '%{http_code}' "$BASE_URL/health")
              if [ "$STATUS" != "200" ]; then
                echo "‚ùå /health returned $STATUS (expected 200)"
                exit 1
              fi
              echo "‚úÖ /health responded with 200"

              # Verify response body
              RESPONSE=$(curl -s "$BASE_URL/health")
              echo "   Response: $RESPONSE"
              if ! echo "$RESPONSE" | grep -q '"ok"'; then
                echo "‚ùå /health response missing 'ok' field"
                exit 1
              fi
              echo "‚úÖ /health response valid"

              # Test /create endpoint (non-destructive dry-run)
              echo ""
              echo "2Ô∏è‚É£  Testing /create endpoint..."
              CREATE_RESPONSE=$(curl -s -X POST "$BASE_URL/create?title=smoke-test-project&description=Automated+smoke+test" || echo "FAILED")

              if echo "$CREATE_RESPONSE" | grep -q '"project_id"'; then
                PROJECT_ID=$(echo "$CREATE_RESPONSE" | grep -o '"project_id":[0-9]*' | grep -o '[0-9]*')
                echo "‚úÖ /create succeeded - created project ID: $PROJECT_ID"
                echo "   Response: $CREATE_RESPONSE"
              elif echo "$CREATE_RESPONSE" | grep -qi "error\|failed"; then
                echo "‚ö†Ô∏è  /create returned error (may be expected if Label Studio not configured):"
                echo "   $CREATE_RESPONSE"
                echo "   This is non-blocking - /health is the critical endpoint"
              else
                echo "‚ö†Ô∏è  /create response unclear:"
                echo "   $CREATE_RESPONSE"
              fi

              echo ""
              echo "üéâ Smoke tests completed!"
              echo "   - /health: ‚úÖ PASS"
              echo "   - /create: tested (see above)"
              echo ""
              echo "project-bootstrapper is operational"
