// Tailscale ACL Policy for Oceanid
// Managed via GitOps - changes pushed to main will auto-deploy
// Docs: https://tailscale.com/kb/1018/acls
// Updated: 2025-10-11 - Fixed TS_TAILNET format (goldfish-inc.org.github)

{
	// Define who owns which tags
	"tagOwners": {
		// K8s cluster devices (managed by Tailscale Kubernetes Operator)
		"tag:k8s": ["autogroup:admin"],
		// Tailscale Kubernetes Operator itself
		"tag:k8s-operator": ["autogroup:admin"],
	},

	// Access control grants (new format)
	"grants": [
		// Allow all members to access each other (existing behavior)
		{
			"src": ["autogroup:member"],
			"dst": ["autogroup:member"],
			"ip":  ["*"],
		},

		// Allow K8s-tagged devices to access everything
		// (cluster pods need outbound access for database, R2, webhooks)
		{
			"src": ["tag:k8s"],
			"dst": ["*"],
			"ip":  ["*"],
		},

		// Allow K8s operator to access everything
		// (operator needs to manage devices on the tailnet)
		{
			"src": ["tag:k8s-operator"],
			"dst": ["*"],
			"ip":  ["*"],
		},

		// Allow all members to access K8s services
		// (enables accessing Argilla UI, metrics endpoints from tailnet)
		{
			"src": ["autogroup:member"],
			"dst": ["tag:k8s"],
			"ip":  ["*"],
		},
	],

	// SSH rules
	"ssh": [
		// Allow all users to SSH into their own devices
		{
			"action": "check",
			"src":    ["autogroup:member"],
			"dst":    ["autogroup:self"],
			"users":  ["autogroup:nonroot", "root"],
		},
		// Allow admins to SSH into K8s-tagged devices
		{
			"action": "accept",
			"src":    ["autogroup:admin"],
			"dst":    ["tag:k8s"],
			"users":  ["autogroup:nonroot", "root"],
		},
	],
}
